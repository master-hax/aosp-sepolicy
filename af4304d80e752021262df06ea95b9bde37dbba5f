{
  "comments": [
    {
      "unresolved": true,
      "key": {
        "uuid": "7265e60f_98c45f7f",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 16,
      "author": {
        "id": 1882526
      },
      "writtenOn": "2024-08-28T11:04:33Z",
      "side": 1,
      "message": "High level question before I dive into the code; why not flip the logic to make `virtmgr`\u0027s children tell the kernel that they don\u0027t want to outlive their parent?\n\nFor example, by issuing (in the `virtmgr` code but really from the child process)\n```\nprctl(PR_SET_PDEATHSIG, SIGKILL); // Not sure which SIGx is best\n```\nbetween the `fork` and `exec` that will run the child (`crosvm`)? This seems considerably simpler (and easier to maintain), if it works.\n\nI\u0027m not sure how to express this from our Rust code, though. In [`run_vm()`](https://cs.android.com/android/platform/superproject/main/+/main:packages/modules/Virtualization/android/virtmgr/src/crosvm.rs;l\u003d882;drc\u003d3a06c7f3a7d2f832390915dca16588372e2496ac), `virtmgr` spawns `crosvm` using the OS-agnostic `std::process::Command` but what I\u0027m describing is specific to Linux (UNIX?). Maybe by using [`std::os::unix::process::CommandExt::pre_exec()`](https://doc.rust-lang.org/std/os/unix/process/trait.CommandExt.html#tymethod.pre_exec)?",
      "range": {
        "startLine": 15,
        "startChar": 48,
        "endLine": 16,
        "endChar": 63
      },
      "revId": "af4304d80e752021262df06ea95b9bde37dbba5f",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "53c2c0a1_449a3538",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 16,
      "author": {
        "id": 1132673
      },
      "writtenOn": "2024-08-28T11:12:49Z",
      "side": 1,
      "message": "I just didn\u0027t know about PR_SET_PDEATHSIG. Thank you!!!\n\nBut it seems to miss the case of children of crosvm. They won\u0027t be killed unless they do the prctl as well. We currently don\u0027t have any children of crosvm, but in the future we may? Is it too early to worry about that?",
      "parentUuid": "7265e60f_98c45f7f",
      "range": {
        "startLine": 15,
        "startChar": 48,
        "endLine": 16,
        "endChar": 63
      },
      "revId": "af4304d80e752021262df06ea95b9bde37dbba5f",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "0598a440_4caa180d",
        "filename": "/COMMIT_MSG",
        "patchSetId": 1
      },
      "lineNbr": 16,
      "author": {
        "id": 1882526
      },
      "writtenOn": "2024-08-28T11:31:26Z",
      "side": 1,
      "message": "If I\u0027m looking at the right code, crosvm\u0027s [`Process::new()`](https://cs.android.com/android/platform/superproject/main/+/main:external/crosvm/src/crosvm/plugin/process.rs;l\u003d197;drc\u003d742791deefeded9392c20835e92a5a215c2421f2) is spawned using `std::process::Command` but note that `crosvm` will try to clean it up in `impl Drop for Process`. Don\u0027t know if that runs when the main process panics (and it definitely doesn\u0027t on `SIGKILL`) but WDYT of bringing this problem up with upstream crosvm?\n\nAs you said, Android doesn\u0027t support crosvm\u0027s sandboxing (yet?) so that\u0027s not a problem in AOSP today, AFAIU.",
      "parentUuid": "53c2c0a1_449a3538",
      "range": {
        "startLine": 15,
        "startChar": 48,
        "endLine": 16,
        "endChar": 63
      },
      "revId": "af4304d80e752021262df06ea95b9bde37dbba5f",
      "serverId": "85c56323-6fa9-3386-8a01-6480fb634889"
    }
  ]
}